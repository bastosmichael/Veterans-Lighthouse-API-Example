<html>

<head>

    <link rel="stylesheet" href="assets/spectre.min.css">
    <link rel="stylesheet" href="assets/spectre-exp.min.css">
    <link rel="stylesheet" href="assets/spectre-icons.min.css">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

    <script src="assets/axios.min.js"></script>
    <script type="text/javascript" src="assets/DOMPurify/purify.min.js"></script>

</head>

<body>

    <header class="navbar">

        <section class="navbar-section">

            <a href="#uploadPacket" class="btn btn-link menuOptions">Upload Packet</a>
            <a href="#viewPacketsInCirculation" class="btn btn-link menuOptions">View Packets in Circulation</a>

        </section>

    </header>

    <br>

    <div id="showUploadForm">

        <form id="transmitPacketToVA">

            <div class="container">

                <div class="columns">

                    <div class="form-group column col-4 col-mx-auto">
                        <label class="form-label" for="veteranFirstName">First Name</label>
                        <input class="form-input" type="text" id="veteranFirstName" placeholder="First Name" required>
                    </div>

                </div>

                <div class="columns">

                    <div class="form-group column col-4 col-mx-auto">
                        <label class="form-label" for="veteranLastName">Last Name</label>
                        <input class="form-input" type="text" id="veteranLastName" placeholder="Last Name" required>
                    </div>

                </div>

                <div class="columns">

                    <div class="form-group column col-4 col-mx-auto">
                        <label class="form-label" for="veteranFileNumber">File Number</label>
                        <input class="form-input" type="text" id="veteranFileNumber" placeholder="File Number">
                    </div>

                </div>

                <div class="columns">

                    <div class="form-group column col-4 col-mx-auto">
                        <label class="form-label" for="veteranZipCode">Zip Code</label>
                        <input class="form-input" type="text" id="veteranZipCode" placeholder="Zip Code">
                    </div>

                </div>

                <div class="columns">

                    <div class="form-group column col-4 col-mx-auto">
                        <label class="form-label" for="veteranUploadSource">Source</label>
                        <input class="form-input" type="text" id="veteranUploadSource" placeholder="Source">
                    </div>

                </div>

                <div class="columns">

                    <div class="form-group column col-4 col-mx-auto">
                        <label class="form-label" for="veteranDocType">Doc Type</label>
                        <input class="form-input" type="text" id="veteranDocType" placeholder="Doc Type">
                    </div>

                </div>

                <div class="columns">

                    <div class="form-group column col-4 col-mx-auto">
                        <label class="form-label" for="veteranMainFile">Main File</label>
                        <input class="form-input" type="file" accept=".pdf" id="veteranMainFile"
                            placeholder="Main File">
                    </div>

                </div>

                <br><br>

                <div class="columns">

                    <div class="column flex-centered">
                        <button class="btn btn-primary" type="button" id="addAttachmentButton">Add Attachment</button>
                    </div>

                    <br><br>

                </div>

                <div id="attachmentsForUpload">

                </div>



                <br><br>

                <div class="columns">

                    <div class="column flex-centered">
                        <button class="btn btn-primary" type="submit" id="submitTotalPacketToVA">SUBMIT PACKET TO
                            VA</button>
                    </div>
                </div>

            </div>

        </form>

    </div>

    <div id="showPacketsInCirculation">

    </div>

    <div class="modal" id="uploadStatusModal">

        <div class="modal-container">

            <div class="modal-header">
                <a href="#close" class="btn btn-clear float-right" aria-label="Close" id="closeStatusModal"></a>
                <div class="modal-title h5" id="uploadModalTitle"></div>
            </div>

            <div class="modal-body">

                <div class="content">
                    <p id="modalUploadMessage"></p>
                </div>

            </div>

        </div>

    </div>


</body>

<script>

    window.addEventListener('load', (event) => {    

        //SETS VARIABLES FOR DOCUMENT ID ELEMENTS. ANY ELEMENT OCCURING MORE THAN ONCE GOES HERE

        const showPacketsInCirculationElement = document.getElementById("showPacketsInCirculation")
        const showUploadFormElement = document.getElementById("showUploadForm")
        const submitTotalPacketToVAElement = document.getElementById("submitTotalPacketToVA")
        const addAttachmentButtonElement = document.getElementById("addAttachmentButton")
        const uploadStatusModalElement = document.getElementById("uploadStatusModal")


        function grabPacketStatuses() {

            //GENERATE THE TABLE IN CODE SO IT CAN BE TOTALLY SANITIZED BY DOMPurify. Prevents XSS

            axios.post("PHP_SCRIPTS/GRAB_VETERAN_STATUSES.php")
                .then(function(response) {

                    let veteranPacketStatuses = response.data

                    let tableHTML = `<table class='table table-striped table-hover'>

                                            <thead>
                                                <tr>
                                                    <th>Veteran Name</th>
                                                    <th>GUID</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>

                                            <tbody>`

                    for(let i = 0; i < veteranPacketStatuses.length; i++) {

                        const veteranGUID = veteranPacketStatuses[i].veteranGUID
                        const veteranStatus = veteranPacketStatuses[i].veteranStatus
                        const veteranFullName = veteranPacketStatuses[i].veteranFullName

                        tableHTML = `${tableHTML} <tr>
                                                        <td>${veteranFullName}</td>
                                                        <td>${veteranGUID}</td>
                                                        <td>${veteranStatus}</td>
                                                    </tr>`
                    }

                    tableHTML = `${tableHTML} </tbody></table>`

                    const tableHTMLPurified = DOMPurify.sanitize(tableHTML)

                    showPacketsInCirculationElement.innerHTML = tableHTMLPurified

                })
        }

        //BEGINNING ELEMENT THAT HIDES ON DOM LOAD
        showPacketsInCirculationElement.hidden = true

        let attachmentCounter = 0 // Attachment Counter for Upload Screen

        //Loops through all menu items and adds the event listener to each item, switch statement below determines which screen to present

        let menuElements = document.getElementsByClassName("menuOptions")

        for(let i = 0; i < menuElements.length; i++) {

            menuElements[i].addEventListener("click", function(event) {

                event.preventDefault()
                let linkedClicked = event.target.innerText

                showUploadFormElement.hidden = true
                showPacketsInCirculationElement.hidden = true

                //THIS IS A SWITCH STATEMENT INSTEAD OF A IF/ELSEIF IN CASE YOU WANT TO ADD MORE OPTIONS, JUST PLUG AND PLAY

                switch (linkedClicked) {

                    case "Upload Packet":
                        showUploadFormElement.hidden = false
                        break;

                    case "View Packets in Circulation":
                        showPacketsInCirculationElement.hidden = false
                        grabPacketStatuses()
                        break;
                }

            })

        }

        //Event Listen for Closing the Upload Status Modal when it pops up

        document.getElementById("closeStatusModal").addEventListener("click", function(event) {
            event.preventDefault()
            uploadStatusModalElement.classList.remove("active")
        })


        //Event Listener for adding an attachment. Real world example you might want to add a remove button

        addAttachmentButtonElement.addEventListener("click", function() {

            attachmentCounter = attachmentCounter + 1

            const newAttachmentOption = `<div class="divider text-center" data-content=""></div><br>

                                                    <div class="columns">

                                                        <div class="form-group column col-4 col-mx-auto">
                                                            <label class="form-label" for="attachment${attachmentCounter}">Attachment ${attachmentCounter}</label>
                                                            <input class="form-input" type="file" accept=".pdf" id="attachment${attachmentCounter}" placeholder="Attachment ${attachmentCounter}">
                                                        </div>

                                                    </div>`

            const newAttachmentOptionSanitized = DOMPurify.sanitize(newAttachmentOption)

            const newAttachmentOptionDIV = document.createElement('div')
            newAttachmentOptionDIV.setAttribute("class", "attachmentDOMDIV")

            newAttachmentOptionDIV.innerHTML = newAttachmentOptionSanitized

            const attachmentUploadDIV = document.getElementById('attachmentsForUpload')
            attachmentUploadDIV.before(newAttachmentOptionDIV)

        })

        //Handles the submission of the packet to the VA

        submitTotalPacketToVAElement.addEventListener("click", function(event) {

            event.preventDefault()

            //HANDLES MAIN FILE ELEMENT

            const veteranMainFileElement = document.getElementById("veteranMainFile")
            const veteranMainFilePDF = veteranMainFileElement.files[0]

            //SETS ALL DATA TO BE USED FOR THE METADATA TRANSACTION

            const veteranFirstName = document.getElementById("veteranFirstName").value
            const veteranLastName = document.getElementById("veteranLastName").value
            const veteranFileNumber = document.getElementById("veteranFileNumber").value
            const veteranZipCode = document.getElementById("veteranZipCode").value
            const vaUploadSource = document.getElementById("veteranUploadSource").value
            const vaDocType = document.getElementById("veteranDocType").value

            //MESSAGE HANDLING. MAINLY USED FOR FILE VALIDATION

            let proceedWithUploadFlag = true
            let reasonUploadNotAllowed = ""

            //Bundles the Veteran's Metadata as an object for transmit

            const veteranMetadataObj = {
                "veteranFirstName": veteranFirstName,
                "veteranLastName": veteranLastName,
                "fileNumber": veteranFileNumber,
                "zipCode": veteranZipCode,
                "source": vaUploadSource,
                "docType": vaDocType
            }

            //Turns the Metadata into a BLOB file. This make it EASIER FOR TRANMISSION when uploading to the VA

            veteranMetadataBLOB = new Blob([JSON.stringify(veteranMetadataObj)], {
                type: "application/json"
            })

            let veteranFormData = new FormData()

            // This is here because the directory created contains the veteran's first name and last name
            veteranFormData.append("veteranFormInformation", JSON.stringify({"veteranFirstName": veteranMetadataObj.veteranFirstName, "veteranLastName": veteranMetadataObj.veteranLastName}))

            // Sends the metadata.json BLOB, as metadata.json
            veteranFormData.append("metadata", veteranMetadataBLOB, "metadata.json")

            if(veteranMainFilePDF.type == "application/pdf") {
                veteranFormData.append("content", veteranMainFilePDF, "content.pdf") // Sends the main pdf as content.pdf
            } else {
                proceedWithUploadFlag = 0
                reasonUploadNotAllowed = `${reasonUploadNotAllowed} MAIN FILE IS AN INVALID FILE TYPE, MUST BE PDF\r\n`
            }

            //Determines if attachments exists or not

            if(attachmentCounter > 0) {

                for(let i = 0; i < attachmentCounter; i++) {

                    const trueElementIteration = i + 1

                    const fileElementName = `attachment${trueElementIteration}` // fileElementName, for finding the ID

                    const fileElementNameIDRef = document.getElementById(fileElementName)
                    const attachmentFilePDF = fileElementNameIDRef.files[0]


                    if(attachmentFilePDF.type == "application/pdf") {

                        const fileElementNameOnDisk = `${fileElementName}.pdf` // fileElementName + pdf, so for example, attachment1.pdf

                        veteranFormData.append(fileElementName,attachmentFilePDF,fileElementNameOnDisk)

                    } else {
                        proceedWithUploadFlag = false
                        reasonUploadNotAllowed = `${reasonUploadNotAllowed} Attachment ${trueElementIteration} is NOT a PDF\r\n`
                    }

                }

            }

            //AXIOS handles post to the back end. Backend has cURL, backend handles the transaction to the VA

            if(proceedWithUploadFlag == true) {

                submitTotalPacketToVAElement.disabled = true
                addAttachmentButtonElement.disabled = true

                submitTotalPacketToVAElement.classList.add("loading") // Makes the button disabled and spin during transaction

                axios.post("PHP_SCRIPTS/UPLOAD_TO_VA.php", veteranFormData)
                    .then(function(response) {

                        submitTotalPacketToVAElement.disabled = false
                        addAttachmentButtonElement.disabled = false
                        submitTotalPacketToVAElement.classList.remove("loading")

                        let modalMessage = ""
                        let modalTitle = ""

                        if(response.data == "UPLOAD SUCCESSFUL") {
                            modalTitle = "Upload Successful"
                            modalMessage = "Packet Uploaded Successfully to the VA"
                        }else {
                            modalTitle = "Upload Failed"
                            modalMessage = "There was a problem uploading the packet"
                        }

                        document.getElementById("uploadModalTitle").innerHTML = modalTitle
                        document.getElementById("modalUploadMessage").innerHTML = modalMessage
                        uploadStatusModalElement.classList.add("active")

                    })

            } else {
                alert(`"CANNOT PROCEED WITH UPLOAD\r\n${reasonUploadNotAllowed}`)
            }

        })



    })

</script>

</html>